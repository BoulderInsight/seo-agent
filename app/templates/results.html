{% extends "base.html" %}

{% block title %}Analysis Results - {{ result.url }}{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-primary: #09090b;
    --bg-elevated: #121215;
    --bg-card: #18181b;
    --bg-hover: #1f1f23;
    --text-primary: #fafafa;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --border: #27272a;
    --border-subtle: #1f1f23;

    --seo: #34d399;
    --seo-dim: rgba(52, 211, 153, 0.12);
    --aeo: #60a5fa;
    --aeo-dim: rgba(96, 165, 250, 0.12);
    --geo: #fbbf24;
    --geo-dim: rgba(251, 191, 36, 0.12);

    --high: #f87171;
    --medium: #fbbf24;
    --low: #34d399;

    --font-display: 'Newsreader', Georgia, serif;
    --font-ui: 'Instrument Sans', system-ui, sans-serif;

    --radius: 10px;
    --radius-sm: 6px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: var(--font-ui);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    font-size: 14px;
}

/* Page Layout */
.results-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.5rem 2rem 3rem;
}

/* Compact Header */
.page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 1.25rem;
    margin-bottom: 1.25rem;
    border-bottom: 1px solid var(--border);
}

.page-header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.page-title {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 500;
    letter-spacing: -0.02em;
}

.url-pill {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: var(--bg-card);
    padding: 0.375rem 0.75rem;
    border-radius: 100px;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    max-width: 300px;
    overflow: hidden;
}

.url-pill span {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.url-pill svg { flex-shrink: 0; opacity: 0.5; }

.meta-text {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    gap: 0.75rem;
}

/* Score Bar - Horizontal compact layout */
.scores-bar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.score-card {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    background: var(--bg-card);
    padding: 0.875rem 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
}

.score-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    border-radius: var(--radius) 0 0 var(--radius);
    opacity: 0;
    transition: opacity 0.15s ease;
}

.score-card.seo::before { background: var(--seo); }
.score-card.aeo::before { background: var(--aeo); }
.score-card.geo::before { background: var(--geo); }

.score-card:hover, .score-card.active {
    border-color: var(--border);
    background: var(--bg-hover);
}

.score-card.active::before { opacity: 1; }

.score-ring-mini {
    width: 48px;
    height: 48px;
    flex-shrink: 0;
    position: relative;
}

.score-ring-mini svg {
    transform: rotate(-90deg);
    width: 100%;
    height: 100%;
}

.score-ring-mini .ring-bg {
    fill: none;
    stroke: var(--bg-primary);
    stroke-width: 5;
}

.score-ring-mini .ring-progress {
    fill: none;
    stroke-width: 5;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.6s ease-out;
}

.score-ring-mini.seo .ring-progress { stroke: var(--seo); }
.score-ring-mini.aeo .ring-progress { stroke: var(--aeo); }
.score-ring-mini.geo .ring-progress { stroke: var(--geo); }

.score-ring-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 600;
}

.score-ring-mini.seo .score-ring-value { color: var(--seo); }
.score-ring-mini.aeo .score-ring-value { color: var(--aeo); }
.score-ring-mini.geo .score-ring-value { color: var(--geo); }

.score-info {
    flex: 1;
    min-width: 0;
}

.score-info-top {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.125rem;
}

.score-label {
    font-weight: 600;
    font-size: 0.9375rem;
}

.score-rating {
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-weight: 600;
}

.score-card.seo .score-rating { background: var(--seo-dim); color: var(--seo); }
.score-card.aeo .score-rating { background: var(--aeo-dim); color: var(--aeo); }
.score-card.geo .score-rating { background: var(--geo-dim); color: var(--geo); }

.score-potential {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Tabs - Pill style */
.tabs-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
    padding: 0.25rem;
    background: var(--bg-card);
    border-radius: var(--radius);
    width: fit-content;
}

.tab-pill {
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: var(--font-ui);
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.tab-pill:hover { color: var(--text-secondary); }

.tab-pill.active {
    background: var(--bg-elevated);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.tab-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
}

.tab-pill.seo .tab-dot { background: var(--seo); }
.tab-pill.aeo .tab-dot { background: var(--aeo); }
.tab-pill.geo .tab-dot { background: var(--geo); }

/* Tab Content */
.tab-content {
    display: none;
    animation: fadeUp 0.2s ease;
}

.tab-content.active { display: block; }

@keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Roadmap Panel */
.roadmap-panel {
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 1rem;
}

.roadmap-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: var(--bg-elevated);
    border-bottom: 1px solid var(--border);
}

.roadmap-title {
    font-family: var(--font-display);
    font-size: 1.0625rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.roadmap-title .score {
    font-weight: 600;
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
}

.roadmap-title .score.seo { background: var(--seo-dim); color: var(--seo); }
.roadmap-title .score.aeo { background: var(--aeo-dim); color: var(--aeo); }
.roadmap-title .score.geo { background: var(--geo-dim); color: var(--geo); }

.target-badge {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.target-badge strong {
    color: var(--text-secondary);
    background: var(--bg-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.roadmap-body {
    padding: 1rem 1.25rem;
}

/* Priority Groups */
.priority-group {
    margin-bottom: 1.25rem;
}

.priority-group:last-child { margin-bottom: 0; }

.priority-label {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.625rem;
}

.priority-label.high { background: rgba(248, 113, 113, 0.12); color: var(--high); }
.priority-label.medium { background: rgba(251, 191, 36, 0.12); color: var(--medium); }
.priority-label.low { background: rgba(52, 211, 153, 0.12); color: var(--low); }

.priority-label svg { width: 12px; height: 12px; }

/* Task List */
.task-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.task-item {
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-subtle);
    transition: all 0.15s ease;
    position: relative;
}

.task-item:hover {
    border-color: var(--border);
}

.task-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.5rem 0.75rem;
    flex-wrap: wrap;
}

.task-title {
    font-weight: 500;
    font-size: 0.8125rem;
    line-height: 1.5;
    flex: 1 1 300px;
    min-width: 0;
    word-wrap: break-word;
    color: var(--text-primary);
}

.task-badges {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
}

.badge {
    font-size: 0.5625rem;
    font-weight: 600;
    padding: 0.125rem 0.3125rem;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.badge.high { background: rgba(248, 113, 113, 0.15); color: var(--high); }
.badge.medium { background: rgba(251, 191, 36, 0.15); color: var(--medium); }
.badge.low { background: rgba(52, 211, 153, 0.15); color: var(--low); }

.badge.quick-win {
    background: linear-gradient(135deg, var(--low), #059669);
    color: white;
}

/* Collapsible Analysis */
.analysis-section {
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
}

.analysis-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1.25rem;
    cursor: pointer;
    transition: background 0.15s ease;
}

.analysis-header:hover { background: var(--bg-elevated); }

.analysis-title {
    font-weight: 500;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.analysis-title svg { opacity: 0.7; }

.chevron-icon {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
    transition: transform 0.2s ease;
}

.analysis-section.open .chevron-icon { transform: rotate(180deg); }

.analysis-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.25s ease;
}

.analysis-section.open .analysis-body { max-height: 1500px; }

.analysis-inner {
    padding: 0 1.25rem 1.25rem;
}

.analysis-summary {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    line-height: 1.6;
}

.analysis-summary strong { color: var(--text-primary); }

.findings-group {
    margin-bottom: 1rem;
}

.findings-group:last-child { margin-bottom: 0; }

.findings-label {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.findings-list {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.finding {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
}

.finding-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
}

.finding-dot.current { background: var(--text-muted); }
.finding-dot.opportunity { background: var(--seo); }
.finding-dot.question { background: var(--aeo); }
.finding-dot.strength { background: var(--geo); }
.finding-dot.risk { background: var(--high); }

/* Downloads */
.downloads-row {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
}

.dl-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.625rem 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-family: var(--font-ui);
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.15s ease;
}

.dl-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    border-color: var(--border);
}

.dl-btn svg {
    width: 16px;
    height: 16px;
    opacity: 0.6;
}

.dl-btn.primary {
    background: linear-gradient(135deg, var(--seo) 0%, var(--aeo) 50%, var(--geo) 100%);
    border: none;
    color: #000;
    font-weight: 600;
    padding: 0.75rem 1.25rem;
}

.dl-btn.primary:hover {
    opacity: 0.9;
    color: #000;
}

.dl-btn.primary svg {
    opacity: 0.8;
}

.dl-divider {
    width: 1px;
    height: 24px;
    background: var(--border);
    margin: 0 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .results-page { padding: 1rem; }
    .page-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
    .scores-bar { grid-template-columns: 1fr; }
    .roadmap-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
    .downloads-row { flex-wrap: wrap; }
}
</style>
{% endblock %}

{% block content %}
<div class="results-page">
    <!-- Compact Header -->
    <header class="page-header">
        <div class="page-header-left">
            <h1 class="page-title">Analysis Complete</h1>
            <div class="url-pill">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                <span>{{ result.url }}</span>
            </div>
        </div>
        <div class="meta-text">
            <span>{{ result.timestamp.strftime('%b %d, %Y') }}</span>
            <span>{{ 'Full Site' if result.mode.value == 'full' else 'Single Page' }}</span>
            <span>{{ result.pages|length }} page{{ 's' if result.pages|length != 1 else '' }}</span>
        </div>
    </header>

    <!-- Horizontal Score Cards -->
    <div class="scores-bar">
        <div class="score-card seo active" data-tab="seo">
            <div class="score-ring-mini seo">
                <svg viewBox="0 0 36 36">
                    <circle class="ring-bg" cx="18" cy="18" r="15"/>
                    <circle class="ring-progress" cx="18" cy="18" r="15"
                            stroke-dasharray="94.2"
                            stroke-dashoffset="{{ 94.2 - (94.2 * result.overall_seo_score / 10) }}"/>
                </svg>
                <span class="score-ring-value">{{ result.overall_seo_score }}</span>
            </div>
            <div class="score-info">
                <div class="score-info-top">
                    <span class="score-label">SEO</span>
                    <span class="score-rating">{{ 'Excellent' if result.overall_seo_score >= 8 else 'Good' if result.overall_seo_score >= 6 else 'Fair' if result.overall_seo_score >= 4 else 'Needs Work' }}</span>
                </div>
                <div class="score-potential">+{{ 10 - result.overall_seo_score }} points possible</div>
            </div>
        </div>

        <div class="score-card aeo" data-tab="aeo">
            <div class="score-ring-mini aeo">
                <svg viewBox="0 0 36 36">
                    <circle class="ring-bg" cx="18" cy="18" r="15"/>
                    <circle class="ring-progress" cx="18" cy="18" r="15"
                            stroke-dasharray="94.2"
                            stroke-dashoffset="{{ 94.2 - (94.2 * result.overall_aeo_score / 10) }}"/>
                </svg>
                <span class="score-ring-value">{{ result.overall_aeo_score }}</span>
            </div>
            <div class="score-info">
                <div class="score-info-top">
                    <span class="score-label">AEO</span>
                    <span class="score-rating">{{ 'Excellent' if result.overall_aeo_score >= 8 else 'Good' if result.overall_aeo_score >= 6 else 'Fair' if result.overall_aeo_score >= 4 else 'Needs Work' }}</span>
                </div>
                <div class="score-potential">+{{ 10 - result.overall_aeo_score }} points possible</div>
            </div>
        </div>

        <div class="score-card geo" data-tab="geo">
            <div class="score-ring-mini geo">
                <svg viewBox="0 0 36 36">
                    <circle class="ring-bg" cx="18" cy="18" r="15"/>
                    <circle class="ring-progress" cx="18" cy="18" r="15"
                            stroke-dasharray="94.2"
                            stroke-dashoffset="{{ 94.2 - (94.2 * result.overall_geo_score / 10) }}"/>
                </svg>
                <span class="score-ring-value">{{ result.overall_geo_score }}</span>
            </div>
            <div class="score-info">
                <div class="score-info-top">
                    <span class="score-label">GEO</span>
                    <span class="score-rating">{{ 'Excellent' if result.overall_geo_score >= 8 else 'Good' if result.overall_geo_score >= 6 else 'Fair' if result.overall_geo_score >= 4 else 'Needs Work' }}</span>
                </div>
                <div class="score-potential">+{{ 10 - result.overall_geo_score }} points possible</div>
            </div>
        </div>
    </div>

    <!-- Pill Tabs -->
    <div class="tabs-container">
        <button class="tab-pill seo active" data-tab="seo">
            <span class="tab-dot"></span>
            SEO Roadmap
        </button>
        <button class="tab-pill aeo" data-tab="aeo">
            <span class="tab-dot"></span>
            AEO Roadmap
        </button>
        <button class="tab-pill geo" data-tab="geo">
            <span class="tab-dot"></span>
            GEO Roadmap
        </button>
    </div>

    <!-- SEO Tab -->
    <div class="tab-content active" id="tab-seo">
        <div class="roadmap-panel">
            <div class="roadmap-header">
                <h2 class="roadmap-title">
                    Path from <span class="score seo">{{ result.overall_seo_score }}/10</span> to <span class="score seo">9/10</span>
                </h2>
                <div class="target-badge">
                    Target: <strong>+{{ 9 - result.overall_seo_score }} pts</strong>
                </div>
            </div>
            <div class="roadmap-body">
                {% set seo_recs = result.recommendations|selectattr('category', 'equalto', 'SEO')|list %}

                {% set high_priority = seo_recs|selectattr('priority.impact', 'equalto', 'high')|list %}
                {% if high_priority %}
                <div class="priority-group">
                    <div class="priority-label high">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        High Impact
                    </div>
                    <div class="task-list">
                        {% for rec in high_priority[:3] %}
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">{{ rec.description }}</div>
                                <div class="task-badges">
                                    {% if loop.first %}<span class="badge quick-win">Quick Win</span>{% endif %}
                                    <span class="badge {{ rec.priority.effort }}">{{ rec.priority.effort }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% set medium_priority = seo_recs|selectattr('priority.impact', 'equalto', 'medium')|list %}
                {% if medium_priority %}
                <div class="priority-group">
                    <div class="priority-label medium">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Medium Impact
                    </div>
                    <div class="task-list">
                        {% for rec in medium_priority[:3] %}
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">{{ rec.description }}</div>
                                <div class="task-badges">
                                    <span class="badge {{ rec.priority.effort }}">{{ rec.priority.effort }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SEO Analysis Details -->
        {% for page_result in result.pages %}
        {% if page_result.seo %}
        <div class="analysis-section open">
            <div class="analysis-header" onclick="this.parentElement.classList.toggle('open')">
                <span class="analysis-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--seo)" stroke-width="2">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    SEO Analysis Details
                </span>
                <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="analysis-body">
                <div class="analysis-inner">
                    <p class="analysis-summary">
                        <strong>Topic:</strong> {{ page_result.seo.primary_topic }}<br>
                        {{ page_result.seo.quality_rationale }}
                    </p>

                    {% if page_result.seo.target_keywords %}
                    <div class="findings-group">
                        <div class="findings-label">Current Keywords</div>
                        <div class="findings-list">
                            {% for kw in page_result.seo.target_keywords %}
                            <div class="finding">
                                <span class="finding-dot current"></span>
                                {{ kw }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if page_result.seo.missing_keywords %}
                    <div class="findings-group">
                        <div class="findings-label">Keyword Opportunities</div>
                        <div class="findings-list">
                            {% for kw in page_result.seo.missing_keywords %}
                            <div class="finding">
                                <span class="finding-dot opportunity"></span>
                                {{ kw }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- AEO Tab -->
    <div class="tab-content" id="tab-aeo">
        <div class="roadmap-panel">
            <div class="roadmap-header">
                <h2 class="roadmap-title">
                    Path from <span class="score aeo">{{ result.overall_aeo_score }}/10</span> to <span class="score aeo">9/10</span>
                </h2>
                <div class="target-badge">
                    Target: <strong>+{{ 9 - result.overall_aeo_score }} pts</strong>
                </div>
            </div>
            <div class="roadmap-body">
                {% set aeo_recs = result.recommendations|selectattr('category', 'equalto', 'AEO')|list %}
                {% set struct_recs = result.recommendations|selectattr('category', 'equalto', 'Structure')|list %}
                {% set all_aeo_recs = aeo_recs + struct_recs %}

                {% set high_priority = all_aeo_recs|selectattr('priority.impact', 'equalto', 'high')|list %}
                {% if high_priority %}
                <div class="priority-group">
                    <div class="priority-label high">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        High Impact
                    </div>
                    <div class="task-list">
                        {% for rec in high_priority[:3] %}
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">{{ rec.description }}</div>
                                <div class="task-badges">
                                    {% if loop.first %}<span class="badge quick-win">Quick Win</span>{% endif %}
                                    <span class="badge {{ rec.priority.effort }}">{{ rec.priority.effort }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% set medium_priority = all_aeo_recs|selectattr('priority.impact', 'equalto', 'medium')|list %}
                {% if medium_priority %}
                <div class="priority-group">
                    <div class="priority-label medium">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Medium Impact
                    </div>
                    <div class="task-list">
                        {% for rec in medium_priority[:3] %}
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">{{ rec.description }}</div>
                                <div class="task-badges">
                                    <span class="badge {{ rec.priority.effort }}">{{ rec.priority.effort }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- AEO Analysis Details -->
        {% for page_result in result.pages %}
        {% if page_result.aeo %}
        <div class="analysis-section open">
            <div class="analysis-header" onclick="this.parentElement.classList.toggle('open')">
                <span class="analysis-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--aeo)" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                        <path d="M12 17h.01"/>
                    </svg>
                    AEO Analysis Details
                </span>
                <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="analysis-body">
                <div class="analysis-inner">
                    <p class="analysis-summary">
                        {{ page_result.aeo.readiness_rationale }}<br>
                        <strong>Featured Snippet Potential:</strong> {{ page_result.aeo.featured_snippet_potential }}
                    </p>

                    {% if page_result.aeo.questions_answered %}
                    <div class="findings-group">
                        <div class="findings-label">Questions Answered</div>
                        <div class="findings-list">
                            {% for q in page_result.aeo.questions_answered %}
                            <div class="finding">
                                <span class="finding-dot current"></span>
                                {{ q }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if page_result.aeo.questions_to_add %}
                    <div class="findings-group">
                        <div class="findings-label">Questions to Add</div>
                        <div class="findings-list">
                            {% for q in page_result.aeo.questions_to_add %}
                            <div class="finding">
                                <span class="finding-dot question"></span>
                                {{ q }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if page_result.aeo.paa_opportunities %}
                    <div class="findings-group">
                        <div class="findings-label">People Also Ask</div>
                        <div class="findings-list">
                            {% for q in page_result.aeo.paa_opportunities %}
                            <div class="finding">
                                <span class="finding-dot opportunity"></span>
                                {{ q }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- GEO Tab -->
    <div class="tab-content" id="tab-geo">
        <div class="roadmap-panel">
            <div class="roadmap-header">
                <h2 class="roadmap-title">
                    Path from <span class="score geo">{{ result.overall_geo_score }}/10</span> to <span class="score geo">9/10</span>
                </h2>
                <div class="target-badge">
                    Target: <strong>+{{ 9 - result.overall_geo_score }} pts</strong>
                </div>
            </div>
            <div class="roadmap-body">
                {% set geo_recs = result.recommendations|selectattr('category', 'equalto', 'GEO')|list %}

                {% set high_priority = geo_recs|selectattr('priority.impact', 'equalto', 'high')|list %}
                {% if high_priority %}
                <div class="priority-group">
                    <div class="priority-label high">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        High Impact
                    </div>
                    <div class="task-list">
                        {% for rec in high_priority[:3] %}
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">{{ rec.description }}</div>
                                <div class="task-badges">
                                    {% if loop.first %}<span class="badge quick-win">Quick Win</span>{% endif %}
                                    <span class="badge {{ rec.priority.effort }}">{{ rec.priority.effort }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% set medium_priority = geo_recs|selectattr('priority.impact', 'equalto', 'medium')|list %}
                {% if medium_priority %}
                <div class="priority-group">
                    <div class="priority-label medium">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Medium Impact
                    </div>
                    <div class="task-list">
                        {% for rec in medium_priority[:3] %}
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">{{ rec.description }}</div>
                                <div class="task-badges">
                                    <span class="badge {{ rec.priority.effort }}">{{ rec.priority.effort }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- GEO Analysis Details -->
        {% for page_result in result.pages %}
        {% if page_result.geo %}
        <div class="analysis-section open">
            <div class="analysis-header" onclick="this.parentElement.classList.toggle('open')">
                <span class="analysis-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--geo)" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    GEO Analysis Details
                </span>
                <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div class="analysis-body">
                <div class="analysis-inner">
                    <p class="analysis-summary">
                        <strong>Originality:</strong> {{ page_result.geo.originality_assessment }}<br>
                        {{ page_result.geo.strength_rationale }}
                    </p>

                    {% if page_result.geo.citation_worthy_elements %}
                    <div class="findings-group">
                        <div class="findings-label">Citation-Worthy Elements</div>
                        <div class="findings-list">
                            {% for el in page_result.geo.citation_worthy_elements %}
                            <div class="finding">
                                <span class="finding-dot strength"></span>
                                {{ el }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if page_result.geo.absorption_risks %}
                    <div class="findings-group">
                        <div class="findings-label">Absorption Risks</div>
                        <div class="findings-list">
                            {% for risk in page_result.geo.absorption_risks %}
                            <div class="finding">
                                <span class="finding-dot risk"></span>
                                {{ risk }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Downloads -->
    <div class="downloads-row">
        <a href="{{ url_for('analysis.download', analysis_id=result.id, format='pdf') }}" class="dl-btn primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6"/>
                <path d="M12 18v-6M9 15l3 3 3-3"/>
            </svg>
            Download Full Report (PDF)
        </a>
        <div class="dl-divider"></div>
        <a href="{{ url_for('analysis.download', analysis_id=result.id, format='markdown') }}" class="dl-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
            Markdown
        </a>
        <a href="{{ url_for('analysis.download', analysis_id=result.id, format='html') }}" class="dl-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6"/>
            </svg>
            HTML
        </a>
        <a href="{{ url_for('analysis.download', analysis_id=result.id, format='csv') }}" class="dl-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6M8 13h2M8 17h2M14 13h2M14 17h2"/>
            </svg>
            CSV
        </a>
    </div>
</div>

<script>
document.querySelectorAll('[data-tab]').forEach(el => {
    el.addEventListener('click', () => {
        const tab = el.dataset.tab;
        document.querySelectorAll('.tab-pill').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
        document.querySelectorAll('.score-card').forEach(card => card.classList.toggle('active', card.dataset.tab === tab));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-${tab}`));
    });
});

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.ring-progress').forEach(ring => {
        const offset = ring.getAttribute('stroke-dashoffset');
        ring.style.strokeDashoffset = '94.2';
        setTimeout(() => ring.style.strokeDashoffset = offset, 50);
    });
});
</script>
{% endblock %}
